@* @model IEnumerable<Labaratory.Models.AnalyzeType> *@
@inject Microsoft.AspNetCore.Identity.UserManager<Labaratory.Models.User> UserManager
@using X.PagedList.Mvc.Core
@model X.PagedList.IPagedList<Labaratory.Models.AnalyzeType>

@{
    ViewData["Title"] = "Список анализов";
}

<div class="card pd-20 pd-sm-40">
    <h6 class="card-body-title">Список анализов</h6>
    <p class="mg-b-20 mg-sm-b-30">Список всех доступных анализов в лаборатории.</p>

    <div class="mb-3">
        <button class="btn btn-success" data-toggle="modal" data-target="#createAnalyzeModal">Добавить новый анализ</button>
        <button class="btn btn-success" data-toggle="modal" data-target="#createAnalyzeCategoryModal">Добавить категорию анализов</button>
    </div>

    <div class="table-responsive">
        <table class="table display responsive nowrap">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Название</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Статус</th>
                    <th>Тип услуги</th>
                    <th>Врач</th>
                    <th>Дата добавления</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@(item.AnalyzeName ?? "Нет данных")</td>
                        <td>@(item.AnalyzeCategory?.CategoryName ?? "Нет категории")</td>
                        <td>@(item.Price?.ToString("F2") ?? "0.00")</td>
                        <td>@(item.Status ? "Активен" : "Неактивен")</td>
                        <td>@(item.TypeAnalyzeID ? "Анализ" : "Другое")</td>
                        <td>@(item.DoctorName ?? "Не указан")</td>
                        <td>@(item.AddDate?.ToString("dd.MM.yyyy") ?? "Не указано")</td>
                        <td>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#editAnalyzeModal-@item.Id">Изменить</button>
                                <a class="btn btn-sm btn-danger ml-1" asp-action="DeleteConfirmed" asp-route-id="@item.Id" onclick="return confirm('Вы уверены, что хотите удалить этот анализ?');">Удалить</a>
                                <button class="btn btn-sm btn-warning ml-1" onclick="openSubItemModal(@item.Id)">Подпоказатели</button>
                            </div>
                        </td>
                    </tr>

                    <!-- Модальное окно редактирования -->
                    <div class="modal fade" id="editAnalyzeModal-@item.Id" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Редактирование анализа</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form asp-action="Edit" asp-route-id="@item.Id" method="post">
                                        <div class="form-group">
                                            <label>Название анализа</label>
                                            <input type="text" name="AnalyzeName" value="@item.AnalyzeName" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Цена</label>
                                            <input type="number" name="Price" value="@item.Price" class="form-control" step="0.01">
                                        </div>
                                        <div class="form-group">
                                            <label>Процент выплаты врачу (%)</label>
                                            <input type="number" name="DoctorPayoutPercentage" class="form-control" step="0.01" min="0" max="100" value="@item.DoctorPayoutPercentage">
                                        </div>

                                        <div class="form-group">
                                            <label>Единица измерения</label>
                                            <input type="text" value="@item.Unit" name="Unit" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Статус</label>
                                            <select name="Status" class="form-control">
                                                <option value="true" selected="@(item.Status ? "selected" : null)">Активен</option>
                                                <option value="false" selected="@(!item.Status ? "selected" : null)">Неактивен</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Выберите врача</label>
                                            <select name="DoctorId" class="form-control">
                                                @foreach (var doctor in UserManager.Users)
                                                {
                                                    <option value="@doctor.Id" selected="@(item.DoctorId == doctor.Id ? "selected" : null)">@doctor.FirsName @doctor.LastName</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Тип анализа</label>
                                            <select name="TypeAnalyzeID" class="form-control">
                                                <option value="true" selected="@(item.TypeAnalyzeID ? "selected" : null)">Анализ</option>
                                                <option value="false" selected="@(!item.TypeAnalyzeID ? "selected" : null)">Другое</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Текст результата</label>
                                            <textarea  name="TextResult" class="form-control" value="@item.TextResult"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Нормальный результат</label>
                                            <input type="text" name="NormalResult" class="form-control" value="@item.NormalResult">
                                        </div>

                                        <div class="form-group">
                                            <label>Категория анализа</label>
                                            <select name="AnalyzeCategoryId" class="form-control">
                                                @foreach (var category in ViewBag.AnalyzeCategories)
                                                {
                                                    <option value="@category.Id" selected="@(item.AnalyzeCategoryId == category.Id ? "selected" : null)">@category.CategoryName</option>
                                                }
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Сохранить</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </tbody>
        </table>
    </div>
    <div class="ht-80 bd d-flex align-items-center justify-content-center">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-basic mg-b-0">
                @if (Model.HasPreviousPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new {page = Model.PageNumber - 1 })" aria-label="Previous">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    </li>
                }
                @for (int i = 1; i <= Model.PageCount; i++)
                {
                    if (i == Model.PageNumber)
                    {
                        <li class="page-item active"><a class="page-link" href="#">@i</a></li>
                    }
                    else
                    {
                        <li class="page-item"><a class="page-link" href="@Url.Action("Index", new { page = i })">@i</a></li>
                    }
                }
                @if (Model.HasNextPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new {page = Model.PageNumber + 1 })" aria-label="Next">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    </div>
</div>

<!-- Модальное окно создания анализа -->
<div class="modal fade" id="createAnalyzeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить новый анализ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form asp-action="Create" method="post">
                    <div class="form-group">
                        <label>Название анализа</label>
                        <input type="text" name="AnalyzeName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Цена</label>
                        <input type="number" name="Price" class="form-control" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Процент выплаты врачу (%)</label>
                        <input type="number" name="DoctorPayoutPercentage" class="form-control" step="0.01" min="0" max="100" value="50">
                    </div>

                    <div class="form-group">
                        <label>Единица измерения</label>
                        <input type="text" name="Unit" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Статус</label>
                        <select name="Status" class="form-control">
                            <option value="true">Активен</option>
                            <option value="false">Неактивен</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Выберите врача</label>
                        <select name="DoctorId" class="form-control">
                            @foreach (var doctor in UserManager.Users)
                            {
                                <option value="@doctor.Id">@doctor.FirsName @doctor.LastName</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Тип анализа</label>
                        <select name="TypeAnalyzeID" class="form-control">
                            <option value="true">Анализ</option>
                            <option value="false">Другое</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Текст результата</label>
                        <textarea name="TextResult" class="form-control"></textarea>
                        
                    </div>
                    <div class="form-group">
                        <label>Норма</label>
                        <input type="text" name="NormalResult" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Категория анализа</label>
                        <select name="AnalyzeCategoryId" class="form-control">
                            @foreach (var category in ViewBag.AnalyzeCategories)
                            {
                                <option value="@category.Id">@category.CategoryName</option>
                            }
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createAnalyzeCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить новый анализ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form asp-action="CreateCategory" method="post">
                    <div class="form-group">
                        <label>Название категории анализа</label>
                        <input type="text" name="CategoryName" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="subItemModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="subItemForm">
            <input type="hidden" id="subItemAnalyzeTypeId" />
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подпоказатели анализа</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="subItemsList" class="mb-3 text-sm"></div>
                    <div class="form-group">
                        <label>Название подпоказателя</label>
                        <input type="text" id="subName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Норма</label>
                        <input type="text" id="subNormal" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Ед. изм.</label>
                        <input type="text" id="subUnit" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitSubItem()">Добавить</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
    function openSubItemModal(analyzeTypeId) {
        $("#subItemAnalyzeTypeId").val(analyzeTypeId);
        $("#subItemsList").html("<i>Загрузка...</i>");
        $("#subItemModal").modal("show");

        fetch(`/AnalyzeTypes/GetSubItems?analyzeTypeId=${analyzeTypeId}`)
            .then(res => res.json())
            .then(data => {
                if (!data || data.length === 0) {
                    $("#subItemsList").html("<i>Нет подпоказателей</i>");
                } else {
                    let html = "<b>Существующие подпоказатели:</b><ul>";
                    data.forEach(s => {
                        html += `<li><b>${s.name}</b> — ${s.normalRange ?? "-"} ${s.unit ?? ""}</li>`;
                    });
                    html += "</ul>";
                    $("#subItemsList").html(html);
                }
            });
    }

    function submitSubItem() {
        const id = $("#subItemAnalyzeTypeId").val();
        const name = $("#subName").val();
        const unit = $("#subUnit").val();
        const normal = $("#subNormal").val();

        if (!name) {
            alert("Введите название подпоказателя");
            return;
        }

        fetch("/AnalyzeTypes/AddSubItem", {
            method: "POST",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                analyzeTypeId: id,
                name: name,
                unit: unit,
                normalRange: normal
            })
        }).then(res => res.json())
          .then(res => {
            if (res.success) {
                openSubItemModal(id); // перезагружаем список
                $("#subName").val("");
                $("#subUnit").val("");
                $("#subNormal").val("");
            } else {
                alert("Ошибка при добавлении");
            }
        });
    }
</script>
